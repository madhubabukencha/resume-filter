{% extends "resume_parser/parser_wrapper.html" %}
{% load i18n %}
{% load allauth account socialaccount %}
{% load markdown_extras %}

{% block head_title %}
    {% trans "Extracted Entities" %}
{% endblock head_title %}

{% block content %}
<div class="container mt-5">
    <center><h3>Extracted Entities</h3></center>
    <hr>
    <!-- Search Bar -->
    <form method="get" class="form-inline mb-4">
        <div class="input-group">
            <!--
            name=q : When a user fills out a form and submits it, Django 
                     collects the data as key-value pairs, where the 'name'
                     attribute is the key, and the corresponding user input
                     is the value
            
            value="{{ request.GET.q }}": This will repopulate the search field
                                         with the user's previous search term if
                                         the page is reloaded after submission, ensuring
                                         that the search term isn't lost after a form 
                                         submission
            -->

            <input class="form-control"
                   type="search"
                   placeholder="Search by filename, UUID, or skills"
                   name="q"
                   value="{{ request.GET.q }}" 
                   aria-label="Search">
            <button class="btn btn-outline-success" type="submit"><b>Search</b></button>
        </div>
    </form>

    {% if entities_list %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>S.Num</th>
                    <th>Unique Identifier</th>
                    <th>Filename</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody>
                {% for entity in entities_list %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ entity.processed_doc.document.unique_identifier }}</td>
                    <td>{{ entity.processed_doc.document.original_filename | truncatechars:35 }}</td>
                    <td>
                        <!-- Button to open the modal -->
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" 
                                data-bs-target="#entityModal{{ entity.id }}">
                            View
                        </button>

                        <!-- Modal for viewing the entity details -->
                        <div class="modal fade" id="entityModal{{ entity.id }}" tabindex="-1" 
                             aria-labelledby="entityModalLabel{{ entity.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="entityModalLabel{{ entity.id }}">
                                            Extracted Information for {{ entity.processed_doc.document.original_filename }}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" 
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <strong style="color: red;">Education Summary:</strong>
                                        <p>{{ entity.education_summary|markdown }}</p>

                                        <strong style="color: red;">Work Experience Summary:</strong>
                                        <p>{{ entity.work_experience_summary|markdown }}</p>

                                        <strong style="color: red;">Resume Summary:</strong>
                                        <p>{{ entity.overall_resume_summary|markdown }}</p>

                                        <strong style="color: red;">Projects Summary:</strong>
                                        <p>{{ entity.projects_summary|markdown }}</p>

                                        <strong style="color: red;">Skills:</strong>
                                        <p>{{ entity.skills|markdown }}</p>

                                        <strong style="color: red;">Contact Details:</strong>
                                        <p>{{ entity.contact_details|markdown }}</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}

            <!-- Display page numbers -->
            {% for i in paginator.page_range %}
            <li class="page-item {% if page_obj.number == i %}active{% endif %}">
                <a class="page-link" href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ i }}</a>
            </li>
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>

    {% else %}
    <br><br>
    <center><h5>No extracted entities found.</h5></center>
    {% endif %}
    
    <!-- Download Button -->
    <form method="get" action="{% url 'download_filtered_data' %}" class="mb-4">
        <input type="hidden" name="q" value="{{ request.GET.q }}">
        <div class="input-group">
            <select name="format" class="form-select" aria-label="Download Format">
                <option value="csv">CSV (All data download if no filter applied)</option>
                <option value="excel">Excel (All  data download if no filter applied)</option>
            </select>
            <button type="submit" class="btn btn-outline-primary"><b>Download Data</b></button>
        </div>
    </form>
</div>
{% endblock content %}
